# MongoDB on AWS EC2 (Terraform)

Terraform module that provisions MongoDB 8.2 on a single EC2 instance with EBS-backed persistence and Elastic IP.

## Architecture

- **EC2**: Amazon Linux 2023, MongoDB 8.2 installed via `user-data.sh`
- **EBS**: Encrypted gp3 volume for `/var/lib/mongo` (data persists across instance replacement)
- **Elastic IP**: Static public IP for the connection string
- **Auth**: Root credentials stored in AWS SSM Parameter Store, fetched at instance boot

## Prerequisites

- [Terraform](https://www.terraform.io/downloads) >= 1.14.5
- AWS CLI configured (credentials or SSO)
- AWS region with default VPC

## Setup

```bash
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars - set mongodb_root_password, restrict ssh_allowed_cidrs/mongodb_allowed_cidrs for production
terraform init
terraform apply
```

## Connect

```bash
# Get the public IP
terraform output ec2_public_ip

# Connect with mongosh (use credentials from terraform.tfvars)
mongosh 'mongodb://USERNAME:PASSWORD@EC2_PUBLIC_IP:27017'
```

Example (replace USERNAME, PASSWORD, and IP):
```
mongodb://USERNAME:PASSWORD@EC2_PUBLIC_IP:27017
```

## Integration (Payload CMS / Hasura)

Set `MONGO_IP` in your hasura `.env.dev` or `.env` to the EC2 public IP:

```bash
terraform -chdir=mongo output ec2_public_ip
```

Then in `hasura/.env.dev`:
```
MONGO_IP=18.158.143.228
MONGO_USER=<from terraform.tfvars>
MONGO_PASSWORD=<from terraform.tfvars>
MONGO_DB=payload
```

The CMS and build will connect to this MongoDB.

## Redeploy

**Replace EC2 instance** (keeps Elastic IP, picks up AMI/user-data changes):
```bash
terraform taint aws_instance.mongolab_ec2_instance
terraform apply
```

**Full teardown:**
```bash
terraform destroy
```

## SSH Access

Private key is generated by Terraform and saved as `mongo-key.pem`:
```bash
chmod 600 mongo-key.pem
ssh -i mongo-key.pem ec2-user@$(terraform output -raw ec2_public_ip)
```

## Security

- **Restrict access**: Set `ssh_allowed_cidrs` and `mongodb_allowed_cidrs` to your IP (e.g. `["1.2.3.4/32"]`) in `terraform.tfvars` for production
- **Change password**: Update the SSM parameter `/mongodb/MONGO_INITDB_ROOT_PASSWORD` in AWS Console after first apply (Terraform ignores changes to the password value)

## CodeCommit

An optional CodeCommit repository is created by default. See [CODECOMMIT.md](CODECOMMIT.md) for setup and migration from GitHub.

## CI/CD

Terraform can be applied automatically via CodePipeline + CodeBuild. See [CICD.md](CICD.md) for setup.

## IAM (Minimal Policies)

For the minimum IAM permissions needed to run Terraform and use CodeCommit, see [docs/IAM-MINIMAL-POLICIES.md](docs/IAM-MINIMAL-POLICIES.md).

## Outputs

| Output | Description |
|--------|-------------|
| `ec2_public_ip` | Elastic IP for MongoDB connection |
| `mongodb_connection_string` | Connection string template (replace `<PASSWORD>`) |
| `ssh_private_key_path` | Path to generated SSH key |
| `codecommit_clone_url_https` | CodeCommit HTTPS clone URL |
| `codecommit_clone_url_ssh` | CodeCommit SSH clone URL |

## License

MIT
